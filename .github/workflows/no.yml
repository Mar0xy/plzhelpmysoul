name: Build FreeBSD Wine Package

on:
push:
branches:
- main
workflow_dispatch:
inputs:
wine_version:
description: 'Specify which Wine flavor to build (e.g., wine, wine-devel, wine-proton)'
required: true
default: 'wine'

jobs:
build-freebsd-pkg:
# Use a Linux runner to host the FreeBSD VM
runs-on: ubuntu-latest
# Removed the 'container' block as we are using a VM action now

steps:
  - name: Checkout Code
    uses: actions/checkout@v4
    
  - name: Build Wine Package on FreeBSD 14.3 VM
    uses: cross-platform-actions/action@v0.29.0
    with:
      operating_system: freebsd
      version: '14.3'
      # The script below runs entirely inside the temporary FreeBSD VM
      run: |
        # Set up the Ports environment
        env PAGER=cat pkg install -y git
        
        # Clone the official FreeBSD Ports tree
        git clone --depth 1 https://cgit.freebsd.org/ports.git /usr/ports

        # Determine the Wine flavor to build from workflow input
        WINE_FLAVOR="${{ github.event.inputs.wine_version || 'wine-stable' }}"
        PORTS_PATH="/usr/ports/emulators/${WINE_FLAVOR}"

        echo "Starting build for flavor: $WINE_FLAVOR"
        
        # Change directory to the specified Wine port
        cd $PORTS_PATH
        
        # Build the package
        make package
        
        # Find the specific .pkg file created in the packages directory.
        PKG_FILE=$(find /usr/ports/packages/All/ -name "${WINE_FLAVOR}*.pkg" | head -n 1)
        
        if [ -z "$PKG_FILE" ]; then
          echo "Error: No package file found after build."
          exit 1
        fi
        
        echo "Successfully built package: $PKG_FILE"
        
        # CRITICAL: Copy the package file to the GITHUB_WORKSPACE 
        # so the subsequent host runner steps can access the artifact.
        cp "$PKG_FILE" "${GITHUB_WORKSPACE}/"

  - name: Upload Wine Package Artifact
    uses: actions/upload-artifact@v4
    with:
      name: freebsd-wine-package
      # Search for any .pkg file copied back to the workspace root
      path: ${{ github.workspace }}/*.pkg
      retention-days: 7
